<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Asignación de Mesas - Conciénciate</title>

    <style>
      :root {
        --azul: #1e3c72;
        --azul2: #2a5298;
        --gris: #444;
      }
      body {
        margin: 0;
        height: 100vh;
        background: #fff;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-family: Arial, sans-serif;
        color: var(--azul);
        text-align: center;
        overflow: hidden;
      }
      .wrap {
        width: min(1100px, 92vw);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 18px;
      }
      img {
        width: min(560px, 86vw);
        height: auto;
        margin-bottom: 8px;
      }

      .card {
        width: 100%;
        border: 2px solid rgba(30, 60, 114, 0.12);
        border-radius: 22px;
        padding: 26px 22px;
        box-shadow: 0 14px 40px rgba(0, 0, 0, 0.08);
        background: linear-gradient(180deg, #fff, #fafcff);
      }

      #mesa {
        font-size: clamp(54px, 7vw, 110px);
        font-weight: 900;
        letter-spacing: 1px;
        margin: 4px 0 8px 0;
        transition: transform 0.2s ease;
      }
      #mesa.pop {
        transform: scale(1.06);
      }

      #mensaje {
        font-size: clamp(18px, 2.3vw, 34px);
        color: var(--gris);
        margin: 0 0 10px 0;
        min-height: 1.4em;
      }

      .meta {
        font-size: clamp(14px, 1.6vw, 20px);
        color: rgba(30, 60, 114, 0.7);
        margin-top: 6px;
      }

      .btn {
        font-size: clamp(22px, 3vw, 42px);
        padding: 18px 54px;
        border: none;
        border-radius: 18px;
        background: linear-gradient(135deg, var(--azul), var(--azul2));
        color: white;
        cursor: pointer;
        box-shadow: 0 12px 26px rgba(30, 60, 114, 0.22);
      }

      .btn.secondary {
        background: white;
        color: var(--azul);
        border: 2px solid rgba(30, 60, 114, 0.25);
        box-shadow: none;
      }

      /* Modal final */
      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.55);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 22px;
      }
      .overlay.show {
        display: flex;
      }

      .modal {
        width: min(760px, 92vw);
        background: white;
        border-radius: 22px;
        padding: 26px;
        box-shadow: 0 18px 60px rgba(0, 0, 0, 0.35);
        text-align: center;
      }
      .modal h2 {
        margin: 0 0 10px 0;
        font-size: clamp(26px, 3.4vw, 44px);
        color: var(--azul);
      }
      .modal p {
        margin: 0 0 18px 0;
        font-size: clamp(16px, 2.1vw, 24px);
        color: var(--gris);
      }
      .actions {
        display: flex;
        gap: 14px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 12px;
      }

      /* Confeti suave */
      .spark {
        position: fixed;
        width: 10px;
        height: 10px;
        border-radius: 3px;
        background: rgba(30, 60, 114, 0.35);
        animation: fall 900ms ease-out forwards;
        pointer-events: none;
      }
      @keyframes fall {
        from {
          transform: translateY(-20px) rotate(0deg);
          opacity: 1;
        }
        to {
          transform: translateY(140px) rotate(180deg);
          opacity: 0;
        }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <img src="descarga.png" alt="Conciénciate" />

      <div class="card">
        <div id="mesa">PULSA PARA ASIGNAR MESA</div>
        <div id="mensaje"></div>

        <button class="btn" id="btn" onclick="tap()">ASIGNAR MESA</button>

        <div class="meta" id="restantes"></div>
      </div>
    </div>

    <!-- Si existe sorteo.mp3 en la carpeta, sonará -->
    <audio id="audioSorteo" src="sorteo.mp3" preload="auto"></audio>

    <div class="overlay" id="overlay">
      <div class="modal">
        <h2>✅ Mesas asignadas</h2>
        <p>
          Ya han salido todas las mesas.<br />¿Quieres reiniciar para empezar de
          nuevo?
        </p>
        <div class="actions">
          <button class="btn" onclick="reiniciarTodo()">REINICIAR</button>
          <button class="btn secondary" onclick="cerrarModal()">CERRAR</button>
        </div>
      </div>
    </div>

    <script>
      let mesas = [];
      let armado = false; // <- “modo confirmación”
      let timerArmado = null;

      const mesaEl = document.getElementById("mesa");
      const msgEl = document.getElementById("mensaje");
      const restEl = document.getElementById("restantes");
      const btn = document.getElementById("btn");
      const overlay = document.getElementById("overlay");
      const audio = document.getElementById("audioSorteo");

      function reiniciar() {
        mesas = [];
        for (let i = 1; i <= 10; i++) mesas.push(i);
        actualizarRestantes();
        desarmar();
      }

      function actualizarRestantes() {
        restEl.textContent = `Mesas restantes: ${mesas.length}/10`;
      }

      function cerrarModal() {
        overlay.classList.remove("show");
      }

      function reiniciarTodo() {
        cerrarModal();
        reiniciar();
        mesaEl.textContent = "PULSA PARA ASIGNAR MESA";
        msgEl.textContent = "";
      }

      function confetiSuave() {
        for (let i = 0; i < 14; i++) {
          const s = document.createElement("div");
          s.className = "spark";
          const x = window.innerWidth / 2 + (Math.random() * 320 - 160);
          const y = window.innerHeight / 2 + (Math.random() * 80 - 40);
          s.style.left = x + "px";
          s.style.top = y + "px";
          document.body.appendChild(s);
          setTimeout(() => s.remove(), 900);
        }
      }

      function animarTexto() {
        mesaEl.classList.remove("pop");
        void mesaEl.offsetWidth;
        mesaEl.classList.add("pop");
        confetiSuave();
      }

      async function sonarSorteo() {
        try {
          audio.currentTime = 0;
          await audio.play();
        } catch (e) {
          // fallback beep
          try {
            const ctx = new (
              window.AudioContext || window.webkitAudioContext
            )();
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.type = "sine";
            o.frequency.value = 880;
            g.gain.value = 0.001;
            o.connect(g);
            g.connect(ctx.destination);
            o.start();
            g.gain.exponentialRampToValueAtTime(0.22, ctx.currentTime + 0.03);
            o.frequency.exponentialRampToValueAtTime(
              1320,
              ctx.currentTime + 0.18,
            );
            g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.28);
            o.stop(ctx.currentTime + 0.3);
          } catch (_) {}
        }
      }

      function armar() {
        armado = true;
        btn.textContent = "CONFIRMAR";
        msgEl.textContent = "Pulsa otra vez para confirmar la mesa.";
        // Si no confirman en 3s, se desarma (evita que quede “enganchado”)
        clearTimeout(timerArmado);
        timerArmado = setTimeout(desarmar, 3000);
      }

      function desarmar() {
        armado = false;
        btn.textContent = "ASIGNAR MESA";
        clearTimeout(timerArmado);
        timerArmado = null;
      }

      function sacarMesaConfirmada() {
        if (mesas.length === 0) {
          overlay.classList.add("show");
          return;
        }

        const index = Math.floor(Math.random() * mesas.length);
        const numero = mesas[index];
        mesas.splice(index, 1);

        mesaEl.textContent = "MESA NÚMERO " + numero;
        msgEl.textContent =
          "Gracias por tu paciencia. Entre todos hacemos un espacio mejor.";
        actualizarRestantes();

        animarTexto();
        sonarSorteo();
      }

      // Un solo punto de entrada
      function tap() {
        // Si no quedan mesas, mostramos modal
        if (mesas.length === 0) {
          overlay.classList.add("show");
          return;
        }

        if (!armado) {
          armar();
          return;
        }

        // Segundo toque = confirmar
        desarmar();
        sacarMesaConfirmada();
      }

      // También evitamos enter/espacio “rebote” si se usa teclado
      document.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
        }
      });

      reiniciar();
    </script>
  </body>
</html>
